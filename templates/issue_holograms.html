{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-share me-2"></i>Issue Holograms
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Current available stock: <strong>{{ "{:,}".format(total_stock) }}</strong> holograms
                </div>
                
                <!-- Calculator Section -->
                <div class="card mb-4 bg-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>Requirement Calculator
                        </h6>
                        <button type="button" class="btn btn-sm btn-success" id="add_row">
                            <i class="fas fa-plus me-1"></i>Add Row
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="calculator_table">
                                <thead>
                                    <tr>
                                        <th>No. of Bottles</th>
                                        <th>No. of Cases</th>
                                        <th>Holograms</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="calculator_tbody">
                                    <tr class="calculator_row">
                                        <td>
                                            <input type="number" class="form-control form-control-sm bottles_input" min="0" value="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm cases_input" min="0" value="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm holograms_output" readonly>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove_row" disabled>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark">
                                        <th colspan="2" class="text-end">Grand Total:</th>
                                        <th>
                                            <input type="number" class="form-control form-control-sm" id="grand_total" readonly>
                                        </th>
                                        <th>
                                            <button type="button" class="btn btn-sm btn-primary" id="use_calculated">
                                                <i class="fas fa-arrow-down me-1"></i>Use Total
                                            </button>
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Add multiple rows to calculate different bottle/case combinations. The grand total will be used for hologram issuance.
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Issue Form -->
                <form method="POST" id="issue_form">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.issue_no.label(class="form-label") }}
                                {{ form.issue_no(class="form-control") }}
                                {% if form.issue_no.errors %}
                                    <div class="text-danger">
                                        {% for error in form.issue_no.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.total_required.label(class="form-label") }}
                                {{ form.total_required(class="form-control", id="total_required") }}
                                {% if form.total_required.errors %}
                                    <div class="text-danger">
                                        {% for error in form.total_required.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.permits.label(class="form-label") }}
                        {{ form.permits(class="form-control", rows="4", placeholder="Enter each permit on a new line in format: PERMIT_NO|YYYY-MM-DD\nExample:\nPERM001|2024-01-15\nPERM002|2024-01-16") }}
                        {% if form.permits.errors %}
                            <div class="text-danger">
                                {% for error in form.permits.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Enter each permit number with its date separated by "|" (pipe character).
                            Use format: PERMIT_NO|YYYY-MM-DD
                        </div>
                    </div>
                    
                    <div class="alert alert-warning" id="stock_warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="warning_message"></span>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('view_issues') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        {{ form.submit(class="btn btn-success") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalRequiredInput = document.getElementById('total_required');
    const useCalculatedBtn = document.getElementById('use_calculated');
    const addRowBtn = document.getElementById('add_row');
    const calculatorTbody = document.getElementById('calculator_tbody');
    const grandTotalInput = document.getElementById('grand_total');
    const stockWarning = document.getElementById('stock_warning');
    const warningMessage = document.getElementById('warning_message');
    const totalStock = {{ total_stock }};
    
    function calculateRowHolograms(row) {
        const bottles = parseInt(row.querySelector('.bottles_input').value) || 0;
        const cases = parseInt(row.querySelector('.cases_input').value) || 0;
        const holograms = bottles * cases;
        
        row.querySelector('.holograms_output').value = holograms;
        calculateGrandTotal();
    }
    
    function calculateGrandTotal() {
        let grandTotal = 0;
        const hologramOutputs = document.querySelectorAll('.holograms_output');
        
        hologramOutputs.forEach(function(output) {
            grandTotal += parseInt(output.value) || 0;
        });
        
        grandTotalInput.value = grandTotal;
        
        // Update use button state
        useCalculatedBtn.disabled = grandTotal === 0;
    }
    
    function updateRemoveButtons() {
        const removeButtons = document.querySelectorAll('.remove_row');
        const rowCount = document.querySelectorAll('.calculator_row').length;
        
        removeButtons.forEach(function(btn) {
            btn.disabled = rowCount <= 1;
        });
    }
    
    function addCalculatorRow() {
        const newRow = document.createElement('tr');
        newRow.className = 'calculator_row';
        newRow.innerHTML = `
            <td>
                <input type="number" class="form-control form-control-sm bottles_input" min="0" value="0">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm cases_input" min="0" value="0">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm holograms_output" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger remove_row">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        calculatorTbody.appendChild(newRow);
        attachRowEventListeners(newRow);
        updateRemoveButtons();
        calculateRowHolograms(newRow);
    }
    
    function removeCalculatorRow(button) {
        const row = button.closest('.calculator_row');
        if (document.querySelectorAll('.calculator_row').length > 1) {
            row.remove();
            updateRemoveButtons();
            calculateGrandTotal();
        }
    }
    
    function attachRowEventListeners(row) {
        const bottlesInput = row.querySelector('.bottles_input');
        const casesInput = row.querySelector('.cases_input');
        const removeBtn = row.querySelector('.remove_row');
        
        bottlesInput.addEventListener('input', function() {
            calculateRowHolograms(row);
        });
        
        casesInput.addEventListener('input', function() {
            calculateRowHolograms(row);
        });
        
        removeBtn.addEventListener('click', function() {
            removeCalculatorRow(this);
        });
    }
    
    function checkStockAvailability() {
        const required = parseInt(totalRequiredInput.value) || 0;
        
        if (required > totalStock) {
            stockWarning.style.display = 'block';
            warningMessage.textContent = `Insufficient stock! You requested ${required.toLocaleString()} but only ${totalStock.toLocaleString()} are available.`;
        } else if (required > 0) {
            stockWarning.style.display = 'none';
        }
    }
    
    // Event listeners
    addRowBtn.addEventListener('click', addCalculatorRow);
    
    totalRequiredInput.addEventListener('input', checkStockAvailability);
    
    useCalculatedBtn.addEventListener('click', function() {
        const grandTotal = parseInt(grandTotalInput.value) || 0;
        if (grandTotal > 0) {
            totalRequiredInput.value = grandTotal;
            checkStockAvailability();
            
            // Visual feedback
            totalRequiredInput.focus();
            totalRequiredInput.style.backgroundColor = '#d4edda';
            setTimeout(function() {
                totalRequiredInput.style.backgroundColor = '';
            }, 1000);
        }
    });
    
    // Form validation
    document.getElementById('issue_form').addEventListener('submit', function(e) {
        const required = parseInt(totalRequiredInput.value) || 0;
        if (required > totalStock) {
            e.preventDefault();
            alert('Cannot issue more holograms than available in stock!');
        }
    });
    
    // Initialize existing rows
    const existingRows = document.querySelectorAll('.calculator_row');
    existingRows.forEach(function(row) {
        attachRowEventListeners(row);
        calculateRowHolograms(row);
    });
    
    updateRemoveButtons();
    checkStockAvailability();
});
</script>
{% endblock %}